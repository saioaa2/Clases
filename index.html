<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Horario semanal</title>
  <style>
    :root {
      --bg: #f9f7fb;
      --primary: #7c3aed;
      --primary-light: #a78bfa;
      --secondary: #c4b5fd;
      --muted: #6b7280;
      --line: #e5e7eb;
    }

    body { margin:0; font-family:"Segoe UI", Roboto, sans-serif; background:var(--bg); color:#1f1f1f; }
    header { background:white; border-bottom:1px solid var(--line); padding:1rem; box-shadow:0 2px 4px rgba(0,0,0,.05); }
    header h1 { margin:0; font-size:1.6rem; color:var(--primary); }
    header .controls { display:flex; flex-wrap:wrap; align-items:center; gap:1rem; margin-top:.5rem; }
    header button { background:var(--primary); color:white; border:none; padding:.4rem .8rem; border-radius:.5rem; cursor:pointer; font-weight:500; }
    header button:hover { background:var(--primary-light); }
    header input, header select { border:1px solid var(--line); border-radius:.4rem; padding:.2rem .4rem; }

    .calendar { display:grid; grid-template-columns:80px repeat(7, 1fr); grid-template-rows:40px auto; overflow-x:auto; gap:0; }
    .day-header { display:contents; }
    .day-header .cell { padding:.5rem; text-align:center; font-weight:500; border-bottom:1px solid var(--line); background:transparent; }
    .day-header .today { background:var(--secondary); border-radius:.5rem; }
    .grid { display:contents; }
    .grid .cell { border:1px solid var(--line); box-sizing:border-box; background:white; }
    .grid .hour { text-align:right; padding-right:.5rem; font-size:.8rem; color:var(--muted); background:transparent; }
    .event { padding:.3rem .4rem; border-radius:.6rem; color:white; font-size:.85rem; box-shadow:0 2px 6px rgba(0,0,0,.15); overflow:hidden; display:flex; flex-direction:column; justify-content:center; }
    .event .title { font-weight:600; margin-bottom:2px; text-transform:capitalize; }
    .event .meta { font-size:.75rem; opacity:.95; }
    .cat-clase { background: var(--primary); }
    .tu-clase { background: #f59e0b; color: #1a1200; }
    .meta-small { font-size:.7rem; opacity:.9; }
  </style>
</head>
<body>
  <header>
    <h1 id="headerTitle">Horario semanal</h1>
    <div class="controls">
      <button id="prev">‚óÄ Semana anterior</button>
      <button id="today">Hoy</button>
      <button id="next">Semana siguiente ‚ñ∂</button>
      <label>Ir a fecha <input id="goDate" type="date" /></label>
      <label>Inicio <select id="startHour"></select></label>
      <label>Fin <select id="endHour"></select></label>
      <label><input id="toggleWeekend" type="checkbox" checked /> Mostrar fin de semana</label>
    </div>
  </header>

  <main class="calendar" id="calendarRoot">
    <div id="dayHeader" class="day-header"></div>
    <div id="grid" class="grid"></div>
  </main>

  <script>
    /* -------------------------
       Aqu√≠ van tus arrays (mismo formato que antes).
       Los he copiado del ejemplo que mandaste (puedes sustituir por tu versi√≥n completa).
       ------------------------- */
    const CLASES = [
      { date: "2025-09-22", start: "09:00", end: "14:00" },
      { date: "2025-09-23", start: "09:00", end: "14:00" },
      { date: "2025-09-23", start: "20:30", end: "21:30" },
      { date: "2025-09-24", start: "09:00", end: "14:00" },
      { date: "2025-09-24", start: "15:00", end: "18:30" },
      { date: "2025-09-25", start: "09:00", end: "14:00" },
      { date: "2025-09-25", start: "15:00", end: "18:30" },
      { date: "2025-09-25", start: "20:00", end: "21:30" },
      { date: "2025-09-26", start: "09:00", end: "14:00" },

      { date: "2025-09-29", start: "09:00", end: "14:00" },
      { date: "2025-09-30", start: "09:00", end: "14:00" },
      { date: "2025-09-30", start: "20:30", end: "21:30" },
      { date: "2025-10-01", start: "09:00", end: "14:00" },
      { date: "2025-10-02", start: "09:00", end: "14:00" },
      { date: "2025-10-02", start: "20:00", end: "21:30" },
      { date: "2025-10-03", start: "09:00", end: "14:00" },

      { date: "2025-10-06", start: "09:00", end: "14:00" },
      { date: "2025-10-07", start: "09:00", end: "14:00" },
      { date: "2025-10-07", start: "20:30", end: "21:30" },
      { date: "2025-10-08", start: "09:00", end: "14:00" },
      { date: "2025-10-09", start: "09:00", end: "14:00" },
      { date: "2025-10-09", start: "20:00", end: "21:30" },
      { date: "2025-10-10", start: "09:00", end: "14:00" },

      { date: "2025-10-13", start: "09:00", end: "14:00" },
      { date: "2025-10-14", start: "09:00", end: "14:00" },
      { date: "2025-10-14", start: "20:30", end: "21:30" },
      { date: "2025-10-15", start: "09:00", end: "14:00" },
      { date: "2025-10-16", start: "09:00", end: "14:00" },
      { date: "2025-10-16", start: "20:00", end: "21:30" },
      { date: "2025-10-17", start: "09:00", end: "14:00" },

      { date: "2025-10-20", start: "09:00", end: "14:00" },
      { date: "2025-10-21", start: "09:00", end: "14:00" },
      { date: "2025-10-21", start: "20:30", end: "21:30" },
      { date: "2025-10-22", start: "09:00", end: "14:00" },
      { date: "2025-10-23", start: "09:00", end: "14:00" },
      { date: "2025-10-23", start: "20:00", end: "21:30" },
      { date: "2025-10-24", start: "09:00", end: "14:00" },

      { date: "2025-10-27", start: "09:00", end: "14:00" },
      { date: "2025-10-28", start: "09:00", end: "14:00" },
      { date: "2025-10-28", start: "20:30", end: "21:30" },
      { date: "2025-10-29", start: "09:00", end: "14:00" },
      { date: "2025-10-30", start: "09:00", end: "14:00" },
      { date: "2025-10-30", start: "20:00", end: "21:30" },
      { date: "2025-10-31", start: "09:00", end: "14:00" },

      { date: "2025-11-10", start: "09:00", end: "21:00" },
      { date: "2025-11-11", start: "09:00", end: "21:00" },
      { date: "2025-11-12", start: "09:00", end: "21:00" },
      { date: "2025-11-13", start: "09:00", end: "21:00" },
      { date: "2025-11-14", start: "09:00", end: "21:00" },

      { date: "2025-11-17", start: "09:00", end: "21:00" },
      { date: "2025-11-18", start: "09:00", end: "21:00" },
      { date: "2025-11-19", start: "09:00", end: "21:00" },
      { date: "2025-11-20", start: "09:00", end: "21:00" },
      { date: "2025-11-21", start: "09:00", end: "21:00" },

      { date: "2025-11-24", start: "09:00", end: "19:30" },
      { date: "2025-11-25", start: "09:00", end: "14:00" },
      { date: "2025-11-25", start: "20:30", end: "21:30" },
      { date: "2025-11-26", start: "09:00", end: "19:30" },
      { date: "2025-10-27", start: "09:00", end: "14:00" },
      { date: "2025-10-27", start: "20:00", end: "21:30" },

      { date: "2025-12-01", start: "09:00", end: "14:00" },
      { date: "2025-12-02", start: "09:00", end: "19:30" },
      { date: "2025-12-02", start: "20:30", end: "21:30" },
      { date: "2025-12-03", start: "09:00", end: "14:00" },
      { date: "2025-12-04", start: "09:00", end: "19:30" },
      { date: "2025-12-04", start: "20:00", end: "21:30" },

      { date: "2025-12-09", start: "09:00", end: "14:00" },
      { date: "2025-12-09", start: "20:30", end: "21:30" },
      { date: "2025-12-10", start: "09:00", end: "14:00" },
      { date: "2025-12-11", start: "09:00", end: "19:30" },
      { date: "2025-12-11", start: "20:00", end: "21:30" },

      { date: "2025-12-15", start: "09:00", end: "19:30" },
      { date: "2025-12-16", start: "09:00", end: "14:00" },
      { date: "2025-12-16", start: "20:30", end: "21:30" },
      { date: "2025-12-17", start: "09:00", end: "19:30" },
      { date: "2025-12-18", start: "09:00", end: "14:00" },
      { date: "2025-12-18", start: "20:00", end: "21:30" },

      // navidad

      { date: "2025-01-07", start: "09:00", end: "14:00" },
      { date: "2025-01-08", start: "09:00", end: "19:30" },
      { date: "2025-01-08", start: "20:00", end: "21:30" },
      { date: "2025-01-09", start: "09:00", end: "14:00" },

      { date: "2025-01-12", start: "09:00", end: "19:30" },
      { date: "2025-01-13", start: "20:30", end: "21:30" },
      { date: "2025-01-14", start: "09:00", end: "19:30" },
      { date: "2025-01-15", start: "09:00", end: "14:00" },

      { date: "2025-01-26", start: "09:00", end: "19:30" },
      { date: "2025-01-27", start: "09:00", end: "14:00" },
      { date: "2025-01-27", start: "20:30", end: "21:30" },
      { date: "2025-01-29", start: "09:00", end: "14:00" },
      { date: "2025-01-29", start: "20:30", end: "21:30" },
      { date: "2025-01-30", start: "09:00", end: "14:00" },

      { date: "2025-02-02", start: "09:00", end: "19:30" },
      { date: "2025-02-03", start: "09:00", end: "19:30" },
      { date: "2025-02-03", start: "20:30", end: "21:30" },
      { date: "2025-02-05", start: "09:00", end: "14:00" },
      { date: "2025-02-05", start: "20:30", end: "21:30" },
      { date: "2025-02-06", start: "09:00", end: "14:00" },

      { date: "2025-02-09", start: "09:00", end: "19:30" },
      { date: "2025-02-10", start: "09:00", end: "19:30" },
      { date: "2025-02-10", start: "20:30", end: "21:30" },
      { date: "2025-02-12", start: "09:00", end: "14:00" },
      { date: "2025-02-12", start: "20:30", end: "21:30" },
      { date: "2025-02-13", start: "09:00", end: "14:00" },

      { date: "2025-02-16", start: "09:00", end: "19:30" },
      { date: "2025-02-17", start: "09:00", end: "19:30" },
      { date: "2025-02-17", start: "20:30", end: "21:30" },
      { date: "2025-02-19", start: "09:00", end: "14:00" },
      { date: "2025-02-19", start: "20:30", end: "21:30" },
      { date: "2025-02-20", start: "09:00", end: "14:00" },

      { date: "2025-02-24", start: "15:00", end: "19:30" },
      { date: "2025-02-24", start: "20:30", end: "21:30" },
      { date: "2025-02-25", start: "09:00", end: "14:00" },
      { date: "2025-02-26", start: "09:00", end: "14:00" },
      { date: "2025-02-26", start: "20:30", end: "21:30" },

      { date: "2025-03-02", start: "09:00", end: "14:00" },
      { date: "2025-03-03", start: "09:00", end: "19:30" },
      { date: "2025-03-03", start: "20:30", end: "21:30" },
      { date: "2025-03-05", start: "09:00", end: "14:00" },
      { date: "2025-03-05", start: "20:30", end: "21:30" },

      { date: "2025-03-10", start: "09:00", end: "19:30" },
      { date: "2025-03-10", start: "20:30", end: "21:30" },
      { date: "2025-03-12", start: "09:00", end: "14:00" },
      { date: "2025-03-12", start: "20:30", end: "21:30" },

      { date: "2025-03-24", start: "20:30", end: "21:30" },
      { date: "2025-03-26", start: "09:00", end: "14:00" },
      { date: "2025-03-26", start: "20:30", end: "21:30" },
      { date: "2025-03-27", start: "09:00", end: "14:00" },
      
      // semana santa

      { date: "2025-04-09", start: "09:00", end: "14:00" },
      { date: "2025-04-09", start: "20:30", end: "21:30" },
      { date: "2025-04-09", start: "09:00", end: "14:00" },

      { date: "2025-04-13", start: "09:00", end: "14:00" },
      { date: "2025-04-14", start: "09:00", end: "14:00" },
      { date: "2025-04-14", start: "20:30", end: "21:30" },
      { date: "2025-04-15", start: "09:00", end: "14:00" },
      { date: "2025-04-16", start: "09:00", end: "14:00" },
      { date: "2025-04-16", start: "20:30", end: "21:30" },
      { date: "2025-04-17", start: "09:00", end: "14:00" },

      { date: "2025-04-20", start: "09:00", end: "14:00" },
      { date: "2025-04-21", start: "09:00", end: "14:00" },
      { date: "2025-04-21", start: "20:30", end: "21:30" },
      { date: "2025-04-22", start: "09:00", end: "14:00" },
      { date: "2025-04-23", start: "09:00", end: "14:00" },
      { date: "2025-04-23", start: "20:30", end: "21:30" },
      { date: "2025-04-24", start: "09:00", end: "14:00" },

      { date: "2025-04-27", start: "09:00", end: "14:00" },
      { date: "2025-04-28", start: "09:00", end: "14:00" },
      { date: "2025-04-28", start: "20:30", end: "21:30" },
      { date: "2025-04-29", start: "09:00", end: "14:00" },
      { date: "2025-04-30", start: "20:30", end: "21:30" },

      { date: "2025-05-04", start: "09:00", end: "14:00" },
      { date: "2025-05-05", start: "09:00", end: "14:00" },
      { date: "2025-05-05", start: "20:30", end: "21:30" },
      { date: "2025-05-06", start: "09:00", end: "14:00" },
      { date: "2025-05-07", start: "09:00", end: "14:00" },
      { date: "2025-05-07", start: "20:30", end: "21:30" },
      { date: "2025-05-08", start: "09:00", end: "14:00" },

      { date: "2025-05-11", start: "09:00", end: "14:00" },
      { date: "2025-05-12", start: "09:00", end: "14:00" },
      { date: "2025-05-12", start: "20:30", end: "21:30" },
      { date: "2025-05-13", start: "09:00", end: "14:00" },
      { date: "2025-05-14", start: "09:00", end: "14:00" },
      { date: "2025-05-14", start: "20:30", end: "21:30" },

      { date: "2025-05-18", start: "09:00", end: "14:00" },
      { date: "2025-05-19", start: "09:00", end: "14:00" },
      { date: "2025-05-19", start: "20:30", end: "21:30" },
      { date: "2025-05-20", start: "09:00", end: "14:00" },
      { date: "2025-05-21", start: "09:00", end: "14:00" },
      { date: "2025-05-21", start: "20:30", end: "21:30" },
      { date: "2025-05-22", start: "09:00", end: "14:00" }
    ];

    // üîπ Horarios por alumno
    const HORARIOS = {
      noa: [
        { date: "2025-09-16", start: "16:00", end: "17:30" },
        { date: "2025-09-23", start: "16:00", end: "17:30" },
        { date: "2025-09-30", start: "16:00", end: "17:30" },
        { date: "2025-10-07", start: "16:00", end: "17:30" },
        { date: "2025-10-14", start: "16:00", end: "17:30" },
        { date: "2025-10-21", start: "16:00", end: "17:30" },
        { date: "2025-10-28", start: "16:00", end: "17:30" },
        { date: "2025-11-25", start: "16:00", end: "17:30" },
        { date: "2025-12-09", start: "16:00", end: "17:30"},
        { date: "2025-12-16", start: "16:00", end: "17:30" },
        { date: "2025-01-13", start: "16:00", end: "17:30" },
        { date: "2025-01-27", start: "16:00", end: "17:30" },
        { date: "2025-03-17", start: "16:00", end: "17:30" },
        { date: "2025-03-24", start: "16:00", end: "17:30" },
        { date: "2025-04-14", start: "16:00", end: "17:30" },
        { date: "2025-04-21", start: "16:00", end: "17:30" },
        { date: "2025-04-28", start: "16:00", end: "17:30" },
        { date: "2025-05-05", start: "16:00", end: "17:30" },
        { date: "2025-05-12", start: "16:00", end: "17:30" },
        { date: "2025-05-19", start: "16:00", end: "17:30" },
        { date: "2025-05-26", start: "16:00", end: "17:30" }
      ],

      adriana: [
        { date: "2025-09-24", start: "19:00", end: "20:00" },
        { date: "2025-10-01", start: "19:00", end: "20:00" },
        { date: "2025-10-08", start: "19:00", end: "20:00" },
        { date: "2025-10-15", start: "19:00", end: "20:00" },
        { date: "2025-10-22", start: "19:00", end: "20:00" },
        { date: "2025-10-29", start: "19:00", end: "20:00" },
        { date: "2025-11-05", start: "19:00", end: "20:00" },
        { date: "2025-12-03", start: "19:00", end: "20:00" },
        { date: "2025-12-10", start: "19:00", end: "20:00" },
        { date: "2025-01-07", start: "19:00", end: "20:00" },
        { date: "2025-01-21", start: "19:00", end: "20:00" },        
        { date: "2025-01-28", start: "19:00", end: "20:00" },
        { date: "2025-02-04", start: "19:00", end: "20:00" },
        { date: "2025-02-11", start: "19:00", end: "20:00" },
        { date: "2025-02-18", start: "19:00", end: "20:00" },
        { date: "2025-02-25", start: "19:00", end: "20:00" },
        { date: "2025-03-04", start: "19:00", end: "20:00" },
        { date: "2025-03-11", start: "19:00", end: "20:00" },
        { date: "2025-03-18", start: "19:00", end: "20:00" },
        { date: "2025-03-25", start: "19:00", end: "20:00" },
        { date: "2025-04-15", start: "19:00", end: "20:00" },
        { date: "2025-04-22", start: "19:00", end: "20:00" },
        { date: "2025-04-29", start: "19:00", end: "20:00" },
        { date: "2025-05-06", start: "19:00", end: "20:00" },
        { date: "2025-05-13", start: "19:00", end: "20:00" },
        { date: "2025-05-20", start: "19:00", end: "20:00" },
        { date: "2025-05-27", start: "19:00", end: "20:00" }
      ]
    };

    const params = new URLSearchParams(window.location.search);
    const alumno = params.get("alumno");              // e.g. "noa" o "profesora"
    const profesor = alumno === "profesora";

    // utilidades
    function toMinutes(hhmm){ const [h,m]=hhmm.split(":").map(Number); return h*60 + m; }
    function dayNumber(d){ const date=new Date(d); return date.getFullYear()*10000 + (date.getMonth()+1)*100 + date.getDate(); }
    function addDays(date,n){ const d=new Date(date); d.setDate(d.getDate()+n); return d; }
    function startOfWeek(date){ const d=new Date(date); const day=(d.getDay()||7); d.setHours(0,0,0,0); d.setDate(d.getDate()- (day-1)); return d; }
    function fmtDateISO(d){ return d.toISOString().slice(0,10); }
    function isToday(d){ const t=new Date(); return d.getFullYear()===t.getFullYear() && d.getMonth()===t.getMonth() && d.getDate()===t.getDate(); }

    // Devuelve true si dos eventos del mismo d√≠a se solapan
    function overlaps(a, b){
      if(a.date !== b.date) return false;
      const a0 = toMinutes(a.start), a1 = toMinutes(a.end);
      const b0 = toMinutes(b.start), b1 = toMinutes(b.end);
      return a0 < b1 && b0 < a1;
    }

    // Construye EVENTS a partir de CLASES: para cada bloque de la profe calculamos qu√© alumnos (si alguno) se solapan
    function buildEventsForView(){
      return CLASES.map(c => {
        // buscar alumnos que tengan alguna clase que se solape con este bloque c
        const alumnos = [];
        for(const nombre in HORARIOS){
          const lista = HORARIOS[nombre];
          if(lista.some(ev => overlaps(ev, c))){
            alumnos.push(nombre);
          }
        }

        let title = "No disponible";
        let tuClase = false;
        if(profesor){
          title = alumnos.length ? "Clase de " + alumnos.join(" / ") : "No disponible";
        } else if(alumno && HORARIOS[alumno]){
          tuClase = alumnos.includes(alumno);
          title = tuClase ? "Tu clase" : "No disponible";
        } else {
          title = "No disponible";
        }

        return {
          ...c,
          title,
          tuClase,
          alumnos
        };
      });
    }

    // SETTINGS
    let dayStart = 8, dayEnd = 22; // horas mostradas
    const DAY_NAMES = ["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];
    const dayHeader = document.getElementById('dayHeader');
    const grid = document.getElementById('grid');
    const calendarRoot = document.getElementById('calendarRoot');
    let anchorDate = new Date();

    // render header (d√≠as visibles seg√∫n toggle weekend)
    function renderHeader(weekStart, visibleDays){
      dayHeader.innerHTML = '';
      // primera celda vac√≠a (columna de horas)
      const empty = document.createElement('div');
      empty.className = 'cell';
      empty.style.gridRow = 1;
      empty.style.gridColumn = 1;
      dayHeader.appendChild(empty);

      for(let i=0;i<visibleDays.length;i++){
        const dayOffset = visibleDays[i]; // 0 = lunes, 6 = domingo
        const d = addDays(weekStart, dayOffset);
        const cell = document.createElement('div');
        cell.className = 'cell ' + (isToday(d) ? 'today' : '');
        cell.style.gridRow = 1;
        cell.style.gridColumn = i+2; // +1 por la columna de horas
        cell.innerHTML = `<div>${DAY_NAMES[dayOffset]}</div><small>${d.toLocaleDateString(undefined,{day:'2-digit',month:'short'})}</small>`;
        dayHeader.appendChild(cell);
      }
    }

    function renderGrid(weekStart){
      grid.innerHTML = '';

      // decidir d√≠as visibles
      const showWeekend = document.getElementById('toggleWeekend').checked;
      const visibleDays = showWeekend ? [0,1,2,3,4,5,6] : [0,1,2,3,4];

      // ajustar grid-template-columns del calendario para que las columnas se adapten al n√∫mero de d√≠as visibles
      calendarRoot.style.gridTemplateColumns = `80px repeat(${visibleDays.length}, 1fr)`;

      const totalRows = (dayEnd - dayStart) * 2; // cada media hora es una fila
      grid.style.gridTemplateRows = `repeat(${totalRows},30px)`;

      // crear celdas horarias y slots
      for(let r=0;r<totalRows;r++){
        if(r%2===0){
          const hourCell = document.createElement('div');
          hourCell.className = 'cell hour';
          hourCell.textContent = String(dayStart + r/2).padStart(2,'0') + ':00';
          hourCell.style.gridRow = `${r+2} / span 2`;
          hourCell.style.gridColumn = 1;
          hourCell.style.display = "flex";
          hourCell.style.alignItems = "center";
          grid.appendChild(hourCell);
        }
        for(let c=0;c<visibleDays.length;c++){
          const slot = document.createElement('div');
          slot.className = 'cell slot';
          slot.style.gridRow = r+2;
          slot.style.gridColumn = c+2;
          grid.appendChild(slot);
        }
      }

      // obtener eventos (solo los bloques CLASES, con t√≠tulo ya calculado)
      const EVENTS = buildEventsForView();

      // rango de semana en n√∫meros para filtrar
      const weekStartNum = dayNumber(weekStart);
      const weekEndNum = dayNumber(addDays(weekStart, 7));

      for(const ev of EVENTS){
        const evDayNum = dayNumber(ev.date);
        if(evDayNum < weekStartNum || evDayNum >= weekEndNum) continue;

        const d = new Date(ev.date);
        const dayIdx = (d.getDay() || 7) - 1; // 0 = lunes ... 6 = domingo
        const colIndex = visibleDays.indexOf(dayIdx);
        if(colIndex === -1) continue; // d√≠a no visible (fin de semana oculto)

        // calcular filas (clamp a la ventana visual)
        const evStartMin = toMinutes(ev.start);
        const evEndMin = toMinutes(ev.end);
        const dayStartMin = dayStart * 60;
        const dayEndMin = dayEnd * 60;

        // si el evento est√° completamente fuera de la vista vertical, saltar
        if(evEndMin <= dayStartMin || evStartMin >= dayEndMin) continue;

        const startClamped = Math.max(evStartMin, dayStartMin);
        const endClamped = Math.min(evEndMin, dayEndMin);

        const startRow = Math.floor((startClamped - dayStartMin) / 30) + 2;
        const endRow = Math.ceil((endClamped - dayStartMin) / 30) + 2;

        const el = document.createElement('div');
        el.className = 'event cat-clase';
        if(!profesor && ev.tuClase) el.className += ' tu-clase';
        el.style.gridColumn = (colIndex + 2); // +1 por columna horas, +1 porque columnas empiezan en 1
        el.style.gridRow = `${startRow} / ${endRow}`;
        const alumnosMeta = (profesor && ev.alumnos && ev.alumnos.length) ? `<div class="meta-small">${ev.alumnos.join(' / ')}</div>` : '';
        el.innerHTML = `<div class="title">${ev.title}</div><div class="meta">${ev.start} ‚Äì ${ev.end}</div>${alumnosMeta}`;
        grid.appendChild(el);
      }
    }

    // selects hora
    function populateHourSelects(){
      const startSel=document.getElementById('startHour');
      const endSel=document.getElementById('endHour');
      startSel.innerHTML=''; endSel.innerHTML='';
      for(let h=0; h<=23; h++){
        const opt1=document.createElement('option'); opt1.value=h; opt1.textContent=String(h).padStart(2,'0')+':00'; startSel.appendChild(opt1);
        const opt2=document.createElement('option'); opt2.value=h; opt2.textContent=String(h).padStart(2,'0')+':00'; endSel.appendChild(opt2);
      }
      startSel.value = dayStart;
      endSel.value = dayEnd;
      startSel.addEventListener('change', ()=>{
        const v = parseInt(startSel.value);
        dayStart = Math.min(v, dayEnd-1);
        render();
      });
      endSel.addEventListener('change', ()=>{
        const v = parseInt(endSel.value);
        dayEnd = Math.max(v, dayStart+1);
        render();
      });
    }

    // controles
    function attachControls(){
      document.getElementById('prev').addEventListener('click', ()=>{ anchorDate = addDays(anchorDate, -7); render(); });
      document.getElementById('next').addEventListener('click', ()=>{ anchorDate = addDays(anchorDate, 7); render(); });
      document.getElementById('today').addEventListener('click', ()=>{ anchorDate = new Date(); render(); });
      document.getElementById('goDate').addEventListener('change', (e)=>{ const d = new Date(e.target.value + 'T00:00'); if(!isNaN(d)) { anchorDate = d; render(); }});
      document.getElementById('toggleWeekend').addEventListener('change', ()=>{ render(); });
    }

    // render principal
    function render(){
      // ajustar t√≠tulo
      if(profesor) document.getElementById('headerTitle').textContent = "Horario de la profesora";
      else if(alumno) document.getElementById('headerTitle').textContent = "Horario de " + alumno;
      else document.getElementById('headerTitle').textContent = "Horario semanal";

      const weekStart = startOfWeek(anchorDate);
      // set fecha input
      document.getElementById('goDate').value = fmtDateISO(anchorDate);

      // construir visibleDays (lo hace renderGrid)
      renderHeaderAndGrid(weekStart);
    }

    // separar renderHeader + renderGrid para pasar visibleDays consistente
    function renderHeaderAndGrid(weekStart){
      // visibleDays interno (tiene que ser id√©ntico en header y grid)
      const showWeekend = document.getElementById('toggleWeekend').checked;
      const visibleDays = showWeekend ? [0,1,2,3,4,5,6] : [0,1,2,3,4];

      // actualizar columnas del calendario
      calendarRoot.style.gridTemplateColumns = `80px repeat(${visibleDays.length}, 1fr)`;

      // render header (usamos la funci√≥n que espera visibleDays)
      // (re-creamos header manualmente para mantener consistencia)
      dayHeader.innerHTML = '';
      const empty = document.createElement('div'); empty.className = 'cell'; empty.style.gridRow = 1; empty.style.gridColumn = 1; dayHeader.appendChild(empty);
      for(let i=0;i<visibleDays.length;i++){
        const dayOffset = visibleDays[i];
        const d = addDays(weekStart, dayOffset);
        const cell = document.createElement('div');
        cell.className = 'cell ' + (isToday(d) ? 'today' : '');
        cell.style.gridRow = 1; cell.style.gridColumn = i+2;
        cell.innerHTML=`<div>${DAY_NAMES[dayOffset]}</div><small>${d.toLocaleDateString(undefined,{day:'2-digit',month:'short'})}</small>`;
        dayHeader.appendChild(cell);
      }

      // render grid using same visibleDays
      // re-create grid content (hours + slots)
      grid.innerHTML = '';
      const totalRows = (dayEnd - dayStart) * 2;
      grid.style.gridTemplateRows = `repeat(${totalRows},30px)`;

      for(let r=0;r<totalRows;r++){
        if(r%2===0){
          const hourCell=document.createElement('div');
          hourCell.className='cell hour';
          hourCell.textContent=String(dayStart + r/2).padStart(2,'0')+':00';
          hourCell.style.gridRow=`${r+2} / span 2`; hourCell.style.gridColumn=1;
          hourCell.style.display="flex"; hourCell.style.alignItems="center"; grid.appendChild(hourCell);
        }
        for(let c=0;c<visibleDays.length;c++){
          const slot=document.createElement('div'); slot.className='cell slot';
          slot.style.gridRow=r+2; slot.style.gridColumn=c+2; grid.appendChild(slot);
        }
      }

      // ahora pintar eventos (misma l√≥gica que before, pero con visibleDays)
      const EVENTS = buildEventsForView();
      const weekStartNum = dayNumber(weekStart);
      const weekEndNum = dayNumber(addDays(weekStart, 7));

      for(const ev of EVENTS){
        const evDayNum = dayNumber(ev.date);
        if(evDayNum < weekStartNum || evDayNum >= weekEndNum) continue;

        const d = new Date(ev.date);
        const dayIdx = (d.getDay() || 7) - 1;
        const colIndex = visibleDays.indexOf(dayIdx);
        if(colIndex === -1) continue;

        const evStartMin = toMinutes(ev.start);
        const evEndMin = toMinutes(ev.end);
        const dayStartMin = dayStart * 60;
        const dayEndMin = dayEnd * 60;
        if(evEndMin <= dayStartMin || evStartMin >= dayEndMin) continue;

        const startClamped = Math.max(evStartMin, dayStartMin);
        const endClamped = Math.min(evEndMin, dayEndMin);
        const startRow = Math.floor((startClamped - dayStartMin) / 30) + 2;
        const endRow = Math.ceil((endClamped - dayStartMin) / 30) + 2;

        const el = document.createElement('div');
        el.className = 'event cat-clase';
        if(!profesor && ev.tuClase) el.className += ' tu-clase';
        el.style.gridColumn = (colIndex + 2);
        el.style.gridRow = `${startRow} / ${endRow}`;
        const alumnosMeta = (profesor && ev.alumnos && ev.alumnos.length) ? `<div class="meta-small">${ev.alumnos.join(' / ')}</div>` : '';
        el.innerHTML = `<div class="title">${ev.title}</div><div class="meta">${ev.start} ‚Äì ${ev.end}</div>${alumnosMeta}`;
        grid.appendChild(el);
      }
    }

    // inicializaci√≥n
    populateHourSelects();
    attachControls();
    // fijar input fecha inicial (hoy)
    document.getElementById('goDate').value = fmtDateISO(anchorDate);
    render();

    // auto-render cada minuto (por si quieres ver "hoy" marcado din√°micamente)
    setInterval(()=>{ render(); }, 60*1000);

  </script>
</body>
</html>